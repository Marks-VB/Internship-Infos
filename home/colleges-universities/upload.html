<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload para universities_and_colleges</title>
    
    <!-- Biblioteca PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background-color: #f4f4f4; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #333; }
        .form-group { margin-bottom: 15px; }
        input[type="file"] { border: 1px solid #ccc; padding: 10px; width: 100%; box-sizing: border-box; border-radius: 4px; }
        button { background-color: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; margin-top: 10px; }
        button:hover { background-color: #218838; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status { margin-top: 20px; padding: 10px; border-radius: 4px; display: none; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        code { background: #eee; padding: 2px 5px; border-radius: 3px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Upload para universities_and_colleges</h2>
    <p>Selecione o arquivo <code>institutions.csv</code>.</p>
    <p><small>Os dados serão estruturados automaticamente (info_geral, localização, etc).</small></p>
    
    <div class="form-group">
        <input type="file" id="csvFile" accept=".csv">
    </div>
    
    <button id="uploadBtn">Enviar para Firebase</button>
    
    <div id="status"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, writeBatch, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // --- SUA CONFIGURAÇÃO ---
    const firebaseConfig = {
        apiKey: "AIzaSyBdUtPoAbOkVCGOBeVRgsq5jZXNOur0f_4",
        authDomain: "internship-infos.firebaseapp.com",
        projectId: "internship-infos",
        storageBucket: "internship-infos.firebasestorage.app",
        messagingSenderId: "642232016135",
        appId: "1:642232016135:web:e2b5645ed285dd73a439a2",
        measurementId: "G-HVFS7M6XEC"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Garante que o DOM carregou antes de buscar os elementos
    window.addEventListener('DOMContentLoaded', () => {
        const fileInput = document.getElementById('csvFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const statusDiv = document.getElementById('status');

        if (!uploadBtn) return;

        uploadBtn.addEventListener('click', () => {
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('Por favor, selecione um arquivo CSV.', 'error');
                return;
            }

            uploadBtn.disabled = true;
            uploadBtn.innerText = "Lendo arquivo...";

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: async function(results) {
                    const data = results.data;
                    console.log("Dados CSV lidos:", data);
                    
                    try {
                        uploadBtn.innerText = "Enviando para Firebase...";
                        await uploadToFirestore(data);
                        showStatus(`Sucesso! ${data.length} instituições processadas em 'universities_and_colleges'.`, 'success');
                    } catch (error) {
                        console.error("Erro no upload:", error);
                        showStatus(`Erro ao salvar: ${error.message}`, 'error');
                    } finally {
                        uploadBtn.disabled = false;
                        uploadBtn.innerText = "Enviar para Firebase";
                    }
                },
                error: function(error) {
                    showStatus(`Erro ao ler CSV: ${error.message}`, 'error');
                    uploadBtn.disabled = false;
                    uploadBtn.innerText = "Enviar para Firebase";
                }
            });
        });

        async function uploadToFirestore(data) {
            // Dividir em lotes de 400 (limite do Firestore é 500 operações por batch)
            const CHUNK_SIZE = 400; 
            const chunks = [];
            
            for (let i = 0; i < data.length; i += CHUNK_SIZE) {
                chunks.push(data.slice(i, i + CHUNK_SIZE));
            }

            console.log(`Dividido em ${chunks.length} lotes.`);

            for (let i = 0; i < chunks.length; i++) {
                const batch = writeBatch(db);
                
                // --- MUDANÇA IMPORTANTE: Coleção correta ---
                const collectionRef = collection(db, "universities_and_colleges"); 

                chunks[i].forEach((csvItem) => {
                    
                    // Estrutura aninhada conforme seu banco de dados
                    const docData = {
                        academicos: {
                            duolingo: "Consultar",
                            grade_cursos: "",
                            site_admissao: ""
                        },
                        contato_coach: {
                            discord: "",
                            nome_coach: "Não listado",
                            twitter_x: ""
                        },
                        esportes_e_jogos: {
                            // Link do CSV ou vazio
                            link_esports: csvItem.website ? csvItem.website.trim() : "",
                            lista_jogos: {
                                csgo: false,
                                lol: false,
                                valorant: false
                            },
                            njcaa: "Não"
                        },
                        info_geral: {
                            descricao: "Sem descrição disponível",
                            // Nome da Instituição do CSV
                            nome: csvItem.institutionName ? csvItem.institutionName.trim() : "",
                            tipo: "College"
                        },
                        localizacao: {
                            // Cidade e Estado do CSV
                            cidade: csvItem.city ? csvItem.city.trim() : "",
                            estado: csvItem.state ? csvItem.state.trim() : ""
                        }
                    };

                    // Define o ID do documento baseado na coluna 'id' do CSV
                    if (csvItem.id) {
                        const docRef = doc(db, "universities_and_colleges", csvItem.id.trim());
                        // { merge: true } garante atualização segura
                        batch.set(docRef, docData, { merge: true }); 
                    } else {
                        // Fallback caso alguma linha não tenha ID (não deve acontecer com o CSV gerado)
                        const docRef = doc(collectionRef);
                        batch.set(docRef, docData);
                    }
                });

                await batch.commit();
                console.log(`Lote ${i+1} enviado com sucesso.`);
            }
        }

        function showStatus(msg, type) {
            statusDiv.style.display = 'block';
            statusDiv.textContent = msg;
            statusDiv.className = type;
        }
    });
</script>

</body>
</html>