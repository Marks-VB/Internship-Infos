<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Universidades & Colleges</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: rgba(99, 102, 241, 0.1);
            --bg-body: #f8fafc;
            --text-main: #0f172a;
            --text-secondary: #64748b;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --radius-md: 12px;
            --radius-lg: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            --header-bg: #ffffff;
        }

        [data-theme="dark"] {
            --bg-body: #020617;
            --text-main: #f8fafc;
            --text-secondary: #94a3b8;
            --card-bg: #0f172a;
            --border: #1e293b;
            --primary-light: rgba(99, 102, 241, 0.2);
            --header-bg: #0f172a;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        * { 
            box-sizing: border-box; 
            transition: background-color 0.2s, border-color 0.2s;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            background-color: var(--header-bg);
            padding: 0.75rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h1 {
            margin: 0;
            font-size: 1.15rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--text-main);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* --- Toolbar/Filtros --- */
        .toolbar {
            background: var(--card-bg);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 20px;
        }

        .filter-group-wrapper {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-wrapper label {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .control {
            background: var(--bg-body);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 8px;
            color: var(--text-main);
            font-size: 0.9rem;
            outline: none;
            min-width: 150px;
        }

        .control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .search-main {
            min-width: 250px;
            background: var(--bg-body);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 12px center;
            padding-left: 38px;
        }

        /* --- Buttons --- */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid transparent;
            white-space: nowrap;
        }

        .btn-primary { background-color: var(--primary); color: #fff; }
        .btn-primary:hover { background-color: var(--primary-hover); }

        .btn-ghost { background: transparent; border-color: var(--border); color: var(--text-main); }
        .btn-ghost:hover { background: var(--bg-body); }

        .btn-icon-only { padding: 10px; border-radius: 10px; }

        /* --- Spreadsheet View --- */
        .content {
            flex-grow: 1;
            overflow: hidden;
            padding: 1.5rem 2rem;
            display: flex;
            flex-direction: column;
        }

        .table-container {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            overflow: auto;
            flex-grow: 1;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 800px;
        }

        th {
            background: var(--header-bg);
            position: sticky;
            top: 0;
            z-index: 20;
            padding: 14px 16px;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
            color: var(--text-main);
            vertical-align: middle;
        }

        tr:nth-child(even) td { background-color: rgba(0,0,0,0.01); }
        [data-theme="dark"] tr:nth-child(even) td { background-color: rgba(255,255,255,0.01); }

        tr:hover td { background-color: var(--primary-light); }

        .sticky-col {
            position: sticky;
            left: 0;
            background: var(--card-bg) !important;
            z-index: 10;
            border-right: 2px solid var(--border);
        }

        .hidden { display: none; }

        /* --- Badges & Status --- */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 700;
            background: var(--primary-light);
            color: var(--primary);
        }

        .badge-success { background: rgba(16, 185, 129, 0.1); color: #059669; }
        .badge-orange { background: rgba(249, 115, 22, 0.1); color: #fb923c; }

        .link-text { color: var(--primary); text-decoration: none; font-weight: 600; }
        .link-text:hover { text-decoration: underline; }

        /* --- Modal Layout --- */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 24px;
        }

        .modal-card {
            background: var(--card-bg);
            width: 100%;
            max-width: 950px;
            max-height: 90vh;
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body { padding: 2rem; overflow-y: auto; }

        .section-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin: 1.5rem 0 1rem 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .column-picker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        .column-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-body);
            border-radius: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
            user-select: none;
        }

        .column-item input { width: 18px; height: 18px; accent-color: var(--primary); }

        .dynamic-list-box {
            background: var(--bg-body);
            padding: 16px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .dynamic-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .modal-footer {
            padding: 1.25rem 2rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: var(--header-bg);
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    </style>
</head>
<body>

<header>
    <div class="brand">
        <div style="background: var(--primary); color: white; padding: 6px; border-radius: 8px; display: flex;">
            <i data-lucide="graduation-cap"></i>
        </div>
        <h1>Portal de Gest√£o Universidades</h1>
    </div>

    <div class="header-actions">
        <div id="syncStatus" style="font-size: 0.8rem; color: var(--success); display: none; align-items: center; gap: 5px;">
            <i data-lucide="check-circle-2" size="16"></i> Sincronizado
        </div>
        <button id="themeToggle" class="btn btn-ghost btn-icon-only">üåô</button>
        <button class="btn btn-primary" id="btnNew">
            <i data-lucide="plus"></i> Adicionar Institui√ß√£o
        </button>
    </div>
</header>

<div class="toolbar">
    <div class="filter-group-wrapper">
        <div class="input-wrapper">
            <label>Pesquisa</label>
            <input type="text" id="globalSearch" class="control search-main" placeholder="Buscar...">
        </div>
        
        <div class="input-wrapper">
            <label>Estado</label>
            <select id="filterState" class="control">
                <option value="">Todos</option>
            </select>
        </div>

        <div class="input-wrapper">
            <label>N√≠vel</label>
            <select id="filterType" class="control">
                <option value="">Todos</option>
                <option value="Junior College">Junior College</option>
                <option value="4-Year University">4-Year University</option>
            </select>
        </div>
    </div>
    
    <div class="header-actions">
        <button class="btn btn-ghost" id="btnManageColumns">
            <i data-lucide="layout"></i> Gerenciar Colunas
        </button>
        <div id="resultsCount" style="font-size: 0.8rem; color: var(--text-secondary); font-weight: 600;">
            0 carregados
        </div>
    </div>
</div>

<div class="content">
    <div class="table-container">
        <table id="mainTable">
            <thead>
                <tr id="tableHeaderRow">
                    <th class="sticky-col" data-col="actions">A√ß√µes</th>
                    <th data-col="nome">Institui√ß√£o</th>
                    <th data-col="tipo">Tipo</th>
                    <th data-col="local">Localiza√ß√£o</th>
                    <th data-col="duo">Duolingo</th>
                    <th data-col="njcaa">NJCAA</th>
                    <th data-col="esports_link">Esports Link</th>
                    <th data-col="jogos">Jogos</th>
                    <th data-col="coaches">Coaches</th>
                    <th data-col="discord">Discord</th>
                    <th data-col="twitter">Twitter/X</th>
                    <th data-col="tuition">Tuition</th>
                    <th data-col="total">Total Anual</th>
                    <th data-col="bolsa">Bolsa M√≠n.</th>
                    <th data-col="cursos">Cursos</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Data populated by JS -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Colunas -->
<div class="modal" id="columnsModal">
    <div class="modal-card" style="max-width: 600px;">
        <div class="modal-header">
            <h2 style="margin:0; font-size:1.25rem;">Exibir Colunas</h2>
            <button class="btn btn-ghost btn-icon-only" onclick="closeColumnsModal()"><i data-lucide="x"></i></button>
        </div>
        <div class="modal-body">
            <p style="color:var(--text-secondary); margin-bottom: 20px;">Marque as colunas que deseja visualizar na tabela principal:</p>
            <div class="column-picker-grid" id="columnPicker">
                <!-- Injected by JS -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeColumnsModal()">Aplicar e Fechar</button>
        </div>
    </div>
</div>

<!-- Modal Editor Completo Restaurado -->
<div class="modal" id="editModal">
    <div class="modal-card">
        <div class="modal-header">
            <div style="display:flex; align-items:center; gap:12px;">
                <i data-lucide="edit-3" class="text-primary"></i>
                <h2 id="modalTitle" style="margin:0; font-size:1.25rem;">Editar Institui√ß√£o</h2>
            </div>
            <button class="btn btn-ghost btn-icon-only" onclick="closeModal()"><i data-lucide="x"></i></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="edit-id">
            
            <div class="section-title"><i data-lucide="info" size="16"></i> Dados Gerais</div>
            <div class="form-row">
                <div class="form-group" style="grid-column: span 2;">
                    <label>Nome da Institui√ß√£o</label>
                    <input type="text" id="edit-nome" class="control" style="width:100%">
                </div>
                <div class="form-group">
                    <label>Tipo (N√≠vel)</label>
                    <input type="text" id="edit-tipo" class="control" placeholder="ex: Junior College" style="width:100%">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Cidade</label>
                    <input type="text" id="edit-cidade" class="control" style="width:100%">
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <input type="text" id="edit-estado" class="control" style="width:100%">
                </div>
                <div class="form-group">
                    <label>NJCAA</label>
                    <select id="edit-njcaa" class="control" style="width:100%">
                        <option value="Sim">Sim</option>
                        <option value="N√£o">N√£o</option>
                    </select>
                </div>
            </div>

            <div class="section-title"><i data-lucide="book-open" size="16"></i> Acad√©mico e Admiss√£o</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Score Duolingo</label>
                    <input type="text" id="edit-duolingo" class="control" style="width:100%">
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Site de Admiss√£o / Infos</label>
                    <input type="text" id="edit-infos" class="control" style="width:100%">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group full-width" style="grid-column: span 3;">
                    <label>Grade de Cursos</label>
                    <input type="text" id="edit-cursos" class="control" style="width:100%">
                </div>
            </div>

            <div class="section-title"><i data-lucide="dollar-sign" size="16"></i> Financeiro</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Tuition & Fees</label>
                    <input type="text" id="edit-tuition" class="control" style="width:100%">
                </div>
                <div class="form-group">
                    <label>Room & Board</label>
                    <input type="text" id="edit-room" class="control" style="width:100%">
                </div>
                <div class="form-group">
                    <label>Custo Total Anual</label>
                    <input type="text" id="edit-custo" class="control" style="width:100%">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Bolsas (Info)</label>
                    <input type="text" id="edit-bolsa" class="control" style="width:100%">
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Link de Custos Direto</label>
                    <input type="text" id="edit-link-custos" class="control" style="width:100%">
                </div>
            </div>

            <div class="section-title"><i data-lucide="gamepad-2" size="16"></i> Esports e Equipa</div>
            <div class="form-row">
                <div class="form-group full-width" style="grid-column: span 3;">
                    <label>Link do Programa de Esports</label>
                    <input type="text" id="edit-link-esports" class="control" style="width:100%">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" style="grid-column: span 1.5;">
                    <label>Jogos Oferecidos</label>
                    <div class="dynamic-list-box" id="gamesList"></div>
                    <button class="btn btn-ghost" style="margin-top:10px; width:100%;" onclick="addGameField('')"><i data-lucide="plus" size="14"></i> Add Jogo</button>
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Equipa de Coaches</label>
                    <div class="dynamic-list-box" id="coachesList"></div>
                    <button class="btn btn-ghost" style="margin-top:10px; width:100%;" onclick="addCoachField('', '', '')"><i data-lucide="user-plus" size="14"></i> Add Coach</button>
                </div>
            </div>

            <div class="section-title"><i data-lucide="message-square" size="16"></i> Observa√ß√µes</div>
            <textarea id="edit-obs" rows="4" class="control" style="width:100%; resize: none;"></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal()">Descartar</button>
            <button class="btn btn-primary" id="saveBtn"><i data-lucide="save"></i> Salvar Altera√ß√µes</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBdUtPoAbOkVCGOBeVRgsq5jZXNOur0f_4",
        authDomain: "internship-infos.firebaseapp.com",
        projectId: "internship-infos",
        storageBucket: "internship-infos.firebasestorage.app",
        messagingSenderId: "642232016135",
        appId: "1:642232016135:web:e2b5645ed285dd73a439a2",
        measurementId: "G-HVFS7M6XEC"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colName = "universities_and_colleges";
    const colRef = collection(db, colName);

    let universities = [];
    
    // --- Gerenciamento de Colunas ---
    const columnDefinitions = [
        { id: 'nome', label: 'Institui√ß√£o' },
        { id: 'tipo', label: 'Tipo' },
        { id: 'local', label: 'Localiza√ß√£o' },
        { id: 'duo', label: 'Duolingo' },
        { id: 'njcaa', label: 'NJCAA' },
        { id: 'esports_link', label: 'Esports Link' },
        { id: 'jogos', label: 'Jogos' },
        { id: 'coaches', label: 'Coaches' },
        { id: 'discord', label: 'Discord' },
        { id: 'twitter', label: 'Twitter/X' },
        { id: 'tuition', label: 'Tuition' },
        { id: 'total', label: 'Total Anual' },
        { id: 'bolsa', label: 'Bolsa M√≠n.' },
        { id: 'cursos', label: 'Cursos' }
    ];

    let visibleColumns = JSON.parse(localStorage.getItem('visibleCols')) || columnDefinitions.map(c => c.id);

    function initColumnPicker() {
        const picker = document.getElementById('columnPicker');
        picker.innerHTML = columnDefinitions.map(col => `
            <label class="column-item">
                <input type="checkbox" value="${col.id}" ${visibleColumns.includes(col.id) ? 'checked' : ''} onchange="toggleColumnVisibility('${col.id}')">
                <span>${col.label}</span>
            </label>
        `).join('');
    }

    window.toggleColumnVisibility = (colId) => {
        if (visibleColumns.includes(colId)) {
            visibleColumns = visibleColumns.filter(id => id !== colId);
        } else {
            visibleColumns.push(colId);
        }
        localStorage.setItem('visibleCols', JSON.stringify(visibleColumns));
        applyFilters();
    };

    window.closeColumnsModal = () => document.getElementById('columnsModal').style.display = 'none';
    document.getElementById('btnManageColumns').onclick = () => {
        initColumnPicker();
        document.getElementById('columnsModal').style.display = 'flex';
        lucide.createIcons();
    };

    // --- Firebase & Render ---
    onSnapshot(colRef, (snapshot) => {
        universities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        populateStateFilter();
        applyFilters();
        lucide.createIcons();
        
        const syncLabel = document.getElementById('syncStatus');
        syncLabel.style.display = 'inline-flex';
        setTimeout(() => syncLabel.style.display = 'none', 3000);
    });

    function populateStateFilter() {
        const select = document.getElementById('filterState');
        const currentVal = select.value;
        const states = [...new Set(universities.map(u => u.localizacao?.estado).filter(Boolean))].sort();
        select.innerHTML = '<option value="">Todos</option>' + 
            states.map(s => `<option value="${s}" ${s === currentVal ? 'selected' : ''}>${s}</option>`).join('');
    }

    function applyFilters() {
        const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
        const stateTerm = document.getElementById('filterState').value;
        const typeTerm = document.getElementById('filterType').value;

        const filtered = universities.filter(u => {
            const matchesSearch = !searchTerm || u.info_geral?.nome?.toLowerCase().includes(searchTerm) || u.localizacao?.cidade?.toLowerCase().includes(searchTerm);
            const matchesState = !stateTerm || u.localizacao?.estado === stateTerm;
            const matchesType = !typeTerm || u.info_geral?.tipo?.includes(typeTerm);
            return matchesSearch && matchesState && matchesType;
        });

        document.getElementById('resultsCount').innerText = `${filtered.length} itens encontrados`;
        renderTable(filtered);
    }

    function renderTable(data) {
        const headerCells = document.querySelectorAll('#tableHeaderRow th');
        headerCells.forEach(th => {
            const colId = th.getAttribute('data-col');
            if (colId !== 'actions') {
                th.classList.toggle('hidden', !visibleColumns.includes(colId));
            }
        });

        const body = document.getElementById('tableBody');
        body.innerHTML = data.map(u => {
            const getCol = (id, content) => `<td class="${visibleColumns.includes(id) ? '' : 'hidden'}">${content}</td>`;
            
            let coachesHtml = "";
            let discordText = "";
            let twitterText = "";

            if (u.contato_coach?.coaches && Array.isArray(u.contato_coach.coaches)) {
                coachesHtml = u.contato_coach.coaches.map(c => `<span class="badge badge-success">${c.nome}</span>`).join('');
                discordText = u.contato_coach.coaches.map(c => c.discord).filter(Boolean).join(', ');
                twitterText = u.contato_coach.coaches.map(c => c.x).filter(Boolean).join(', ');
            } else if (u.contato_coach) {
                if (u.contato_coach.nome_coach) coachesHtml = `<span class="badge badge-success">${u.contato_coach.nome_coach}</span>`;
                discordText = u.contato_coach.discord || "";
                twitterText = u.contato_coach.twitter_x || u.contato_coach.x || "";
            }

            let gamesHtml = "";
            const gamesData = u.esportes_e_jogos?.lista_jogos;
            if (Array.isArray(gamesData)) {
                gamesHtml = gamesData.map(g => `<span class="badge">${g}</span>`).join('');
            } else if (gamesData && typeof gamesData === 'object') {
                const activeGames = Object.keys(gamesData).filter(k => gamesData[k] === true);
                gamesHtml = activeGames.map(g => `<span class="badge">${g.toUpperCase()}</span>`).join('');
            }

            const esportsUrl = u.esportes_e_jogos?.link_esports;
            const esportsLinkHtml = (esportsUrl && esportsUrl.trim() !== "") 
                ? `<a href="${esportsUrl}" target="_blank" class="link-text"><i data-lucide="external-link" size="14"></i> Site</a>` 
                : '-';

            return `
                <tr>
                    <td class="sticky-col"><button class="btn btn-ghost" onclick="openEdit('${u.id}')">EDITAR</button></td>
                    ${getCol('nome', `<strong>${u.info_geral?.nome || '-'}</strong>`)}
                    ${getCol('tipo', `<span class="badge badge-orange">${u.info_geral?.tipo || 'N/A'}</span>`)}
                    ${getCol('local', `${u.localizacao?.cidade || ''}, ${u.localizacao?.estado || ''}`)}
                    ${getCol('duo', u.academicos?.duolingo || '-')}
                    ${getCol('njcaa', u.esportes_e_jogos?.njcaa || '-')}
                    ${getCol('esports_link', esportsLinkHtml)}
                    ${getCol('jogos', gamesHtml || '-')}
                    ${getCol('coaches', coachesHtml || '-')}
                    ${getCol('discord', discordText || '-')}
                    ${getCol('twitter', twitterText || '-')}
                    ${getCol('tuition', u.financeiro?.tuition_fees || '-')}
                    ${getCol('total', `<b>${u.financeiro?.custo_total || '-'}</b>`)}
                    ${getCol('bolsa', u.financeiro?.bolsa || '-')}
                    ${getCol('cursos', u.academicos?.grade_cursos || '-')}
                </tr>
            `;
        }).join('');
        lucide.createIcons();
    }

    // --- Modal Editor Actions ---
    window.addGameField = (val) => {
        const container = document.getElementById('gamesList');
        const div = document.createElement('div');
        div.className = 'dynamic-item';
        div.innerHTML = `
            <input type="text" class="game-input control" value="${val}" placeholder="ex: League of Legends" style="flex:1">
            <button class="btn btn-ghost" style="color:var(--danger); border-color:transparent" onclick="this.parentElement.remove()"><i data-lucide="trash-2" size="16"></i></button>
        `;
        container.appendChild(div);
        lucide.createIcons();
    };

    window.addCoachField = (nome, discord, x) => {
        const container = document.getElementById('coachesList');
        const div = document.createElement('div');
        div.className = 'dynamic-item';
        div.innerHTML = `
            <input type="text" class="coach-nome control" value="${nome}" placeholder="Nome" style="flex:1.5">
            <input type="text" class="coach-discord control" value="${discord}" placeholder="Discord" style="flex:1">
            <input type="text" class="coach-x control" value="${x}" placeholder="Twitter" style="flex:1">
            <button class="btn btn-ghost" style="color:var(--danger); border-color:transparent" onclick="this.parentElement.remove()"><i data-lucide="trash-2" size="16"></i></button>
        `;
        container.appendChild(div);
        lucide.createIcons();
    };

    window.openEdit = (id) => {
        const uni = id ? universities.find(u => u.id === id) : null;
        document.getElementById('edit-id').value = id || '';
        document.getElementById('modalTitle').innerText = id ? 'Editar Institui√ß√£o' : 'Nova Institui√ß√£o';
        
        document.getElementById('edit-nome').value = uni?.info_geral?.nome || '';
        document.getElementById('edit-tipo').value = uni?.info_geral?.tipo || '';
        document.getElementById('edit-cidade').value = uni?.localizacao?.cidade || '';
        document.getElementById('edit-estado').value = uni?.localizacao?.estado || '';
        document.getElementById('edit-duolingo').value = uni?.academicos?.duolingo || '';
        document.getElementById('edit-njcaa').value = uni?.esportes_e_jogos?.njcaa || 'Sim';
        document.getElementById('edit-infos').value = uni?.academicos?.site_admissao || '';
        document.getElementById('edit-tuition').value = uni?.financeiro?.tuition_fees || '';
        document.getElementById('edit-room').value = uni?.financeiro?.room_board || '';
        document.getElementById('edit-custo').value = uni?.financeiro?.custo_total || '';
        document.getElementById('edit-bolsa').value = uni?.financeiro?.bolsa || '';
        document.getElementById('edit-link-custos').value = uni?.financeiro?.link_custos || '';
        document.getElementById('edit-obs').value = uni?.info_geral?.descricao || '';
        document.getElementById('edit-cursos').value = uni?.academicos?.grade_cursos || '';
        document.getElementById('edit-link-esports').value = uni?.esportes_e_jogos?.link_esports || '';

        document.getElementById('gamesList').innerHTML = '';
        const games = uni?.esportes_e_jogos?.lista_jogos;
        if (Array.isArray(games)) games.forEach(g => addGameField(g));
        else if (games && typeof games === 'object') Object.keys(games).filter(k => games[k] === true).forEach(k => addGameField(k.toUpperCase()));

        document.getElementById('coachesList').innerHTML = '';
        if (uni?.contato_coach?.coaches && Array.isArray(uni.contato_coach.coaches)) {
            uni.contato_coach.coaches.forEach(c => addCoachField(c.nome, c.discord, c.x));
        } else if (uni?.contato_coach?.nome_coach) {
            addCoachField(uni.contato_coach.nome_coach, uni.contato_coach.discord || "", uni.contato_coach.twitter_x || uni.contato_coach.x || "");
        }

        document.getElementById('editModal').style.display = 'flex';
        lucide.createIcons();
    };

    window.closeModal = () => document.getElementById('editModal').style.display = 'none';

    document.getElementById('btnNew').onclick = () => window.openEdit('');

    document.getElementById('saveBtn').onclick = async () => {
        const id = document.getElementById('edit-id').value;
        const games = Array.from(document.querySelectorAll('.game-input')).map(i => i.value).filter(Boolean);
        const coaches = Array.from(document.querySelectorAll('#coachesList .dynamic-item')).map(div => ({
            nome: div.querySelector('.coach-nome').value,
            discord: div.querySelector('.coach-discord').value,
            x: div.querySelector('.coach-x').value
        })).filter(c => c.nome);

        const data = {
            info_geral: {
                nome: document.getElementById('edit-nome').value,
                tipo: document.getElementById('edit-tipo').value,
                descricao: document.getElementById('edit-obs').value
            },
            localizacao: {
                cidade: document.getElementById('edit-cidade').value,
                estado: document.getElementById('edit-estado').value
            },
            academicos: {
                duolingo: document.getElementById('edit-duolingo').value,
                site_admissao: document.getElementById('edit-infos').value,
                grade_cursos: document.getElementById('edit-cursos').value
            },
            financeiro: {
                tuition_fees: document.getElementById('edit-tuition').value,
                room_board: document.getElementById('edit-room').value,
                custo_total: document.getElementById('edit-custo').value,
                bolsa: document.getElementById('edit-bolsa').value,
                link_custos: document.getElementById('edit-link-custos').value
            },
            esportes_e_jogos: {
                njcaa: document.getElementById('edit-njcaa').value,
                link_esports: document.getElementById('edit-link-esports').value,
                lista_jogos: games
            },
            contato_coach: {
                coaches: coaches,
                nome_coach: coaches[0]?.nome || "",
                discord: coaches[0]?.discord || "",
                twitter_x: coaches[0]?.x || ""
            }
        };

        try {
            if (id) await updateDoc(doc(db, colName, id), data);
            else await addDoc(colRef, data);
            closeModal();
        } catch (e) {
            alert("Erro ao salvar: " + e.message);
        }
    };

    document.getElementById('globalSearch').oninput = applyFilters;
    document.getElementById('filterState').onchange = applyFilters;
    document.getElementById('filterType').onchange = applyFilters;

    const themeBtn = document.getElementById('themeToggle');
    themeBtn.onclick = () => {
        const current = document.body.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', next);
        themeBtn.innerText = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    };

    window.onclick = (e) => { if(e.target == document.getElementById('editModal')) closeModal(); };
</script>

</body>
</html>