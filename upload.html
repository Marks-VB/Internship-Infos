<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload CSV para Firebase</title>
    
    <!-- Biblioteca para ler CSV corretamente (lida com aspas e vírgulas) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background-color: #f4f4f4; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #333; }
        .form-group { margin-bottom: 15px; }
        input[type="file"] { border: 1px solid #ccc; padding: 10px; width: 100%; box-sizing: border-box; border-radius: 4px; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status { margin-top: 20px; padding: 10px; border-radius: 4px; display: none; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        pre { background: #eee; padding: 10px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Upload de Estados (CSV)</h2>
    <p>Selecione o arquivo <code>states.csv</code> para enviar ao Firestore.</p>
    
    <div class="form-group">
        <input type="file" id="csvFile" accept=".csv">
    </div>
    
    <button id="uploadBtn">Enviar para Firebase</button>
    
    <div id="status"></div>
    <div id="log" style="margin-top:10px;"></div>
</div>

<script type="module">
    // Importando Firebase do CDN (necessário para rodar direto no HTML sem bundler)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, writeBatch, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // Sua Configuração
    const firebaseConfig = {
        apiKey: "AIzaSyBdUtPoAbOkVCGOBeVRgsq5jZXNOur0f_4",
        authDomain: "internship-infos.firebaseapp.com",
        projectId: "internship-infos",
        storageBucket: "internship-infos.firebasestorage.app",
        messagingSenderId: "642232016135",
        appId: "1:642232016135:web:e2b5645ed285dd73a439a2",
        measurementId: "G-HVFS7M6XEC"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Elementos da DOM
    const fileInput = document.getElementById('csvFile');
    const uploadBtn = document.getElementById('uploadBtn');
    const statusDiv = document.getElementById('status');
    const logDiv = document.getElementById('log');

    // Função para converter strings numéricas em Numbers reais
    const parseValue = (val) => {
        if (!val) return val;
        const isNumber = !isNaN(parseFloat(val)) && isFinite(val);
        // Se parece número, converte. Se não, mantém string.
        return isNumber ? parseFloat(val) : val.trim();
    };

    uploadBtn.addEventListener('click', () => {
        const file = fileInput.files[0];
        
        if (!file) {
            showStatus('Por favor, selecione um arquivo CSV.', 'error');
            return;
        }

        uploadBtn.disabled = true;
        uploadBtn.innerText = "Processando...";

        // Usando PapaParse para ler o CSV
        Papa.parse(file, {
            header: true, // Usa a primeira linha como nomes dos campos
            skipEmptyLines: true,
            complete: async function(results) {
                const data = results.data;
                console.log("Dados lidos:", data);
                
                try {
                    await uploadToFirestore(data);
                    showStatus(`Sucesso! ${data.length} estados foram salvos no banco de dados.`, 'success');
                } catch (error) {
                    console.error("Erro no upload:", error);
                    showStatus(`Erro ao salvar: ${error.message}`, 'error');
                } finally {
                    uploadBtn.disabled = false;
                    uploadBtn.innerText = "Enviar para Firebase";
                }
            },
            error: function(error) {
                showStatus(`Erro ao ler CSV: ${error.message}`, 'error');
                uploadBtn.disabled = false;
            }
        });
    });

    async function uploadToFirestore(data) {
        // O Firestore tem um limite de 500 operações por Batch.
        // Como temos 50 estados, um único batch resolve.
        const batch = writeBatch(db);
        const collectionRef = collection(db, "states");

        data.forEach((item) => {
            // Limpeza e Tipagem dos dados
            const docData = {};
            
            // Itera sobre as chaves do objeto CSV
            Object.keys(item).forEach(key => {
                // Remove espaços extras das chaves e valores
                const cleanKey = key.trim(); 
                docData[cleanKey] = parseValue(item[key]);
            });

            // Se o CSV tiver uma coluna 'id' (AL, AK, etc), usamos como ID do documento
            // Se não tiver, o Firestore gera um ID aleatório
            if (docData.id) {
                const docRef = doc(db, "states", docData.id);
                batch.set(docRef, docData); // .set substitui se já existir
            } else {
                const docRef = doc(collectionRef); // Gera ID auto
                batch.set(docRef, docData);
            }
        });

        await batch.commit();
    }

    function showStatus(msg, type) {
        statusDiv.style.display = 'block';
        statusDiv.textContent = msg;
        statusDiv.className = type;
    }
</script>

</body>
</html>